<!DOCTYPE html>
<html>

<head>
    <title>Redux_Middleware</title>
    <script src="https://unpkg.com/redux@4.2.1/dist/redux.js"></script>
</head>

<body>

    <h2>Users</h2>
    <button id="load">Load Users</button>
    <ul id="users"></ul>

    <script>
        /*   1. Thunk Middleware */
        const thunk = store => next => action => {
            if (typeof action === "function") {
                return action(store.dispatch, store.getState);
            }
            return next(action);
        }

        /* 2. Initial State */
        const initialState = {
            users: [],
            loading: false
        };

        /* 3. Reducer */
        function reducer(state = initialState, action) {
            switch (action.type) {
                case "FETCH_START":
                    return { ...state, loading: true };

                case "FETCH_SUCCESS":
                    return { users: action.payload, loading: false };

                default:
                    return state;
            }
        }

        /* 4. Create Store with Middleware */
        const store = Redux.createStore(
            reducer,
            Redux.applyMiddleware(thunk)
        );

        /* 5. Async Action (Thunk) */
        function fetchUsers() {
            return function (dispatch) {
                dispatch({ type: "FETCH_START" });

                fetch("https://jsonplaceholder.typicode.com/users")
                    .then(res => res.json())
                    .then(data => {
                        dispatch({ type: "FETCH_SUCCESS", payload: data });
                    });
            };
        }

        /* 6. Render UI */
        const userList = document.getElementById("users");

        function render() {
            const state = store.getState();
            userList.innerHTML = "";

            if (state.loading) {
                userList.innerHTML = "<li>Loading...</li>";
                return;
            }

            state.users.forEach(user => {
                const li = document.createElement("li");
                li.textContent = user.name;
                userList.appendChild(li);
            });
        }

        store.subscribe(render);

        /* 7. Button Click */
        document.getElementById("load").onclick = () => {
            store.dispatch(fetchUsers());
        };
    </script>

</body>

</html>